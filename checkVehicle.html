<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="CSS/styles.css">
    <title>Double Parking Notification System</title>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <ion-icon name="search" style="font-size:25px;"></ion-icon>
        SEARCH VEHICLE
    </div>
    <br><br>

    <!-- Input -->
    <div>
        <input class="input-bar" type="text" id="vehicleNo" name="vehicleNo" placeholder="Plate Number">
    </div>

    <!-- Button -->
    <div>
        <button type="button" class="submit_btn" style="display: block;" onclick="verifyPlate()">
            <ion-icon name="chevron-forward-circle-outline"></ion-icon>
        </button>
    </div>

    <!-- Footer -->
    <div class="footer">
        Copyright © 2021 Dumpling Grads • Made with sweat and tears
    </div>

    <!-- Function -->
    <script>
        function checkPlate(toVerify) {
            var plateNum = document.getElementById("vehicleNo").value;
            return toVerify == plateNum;
        }
    </script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <!-- Insert this script at the bottom of the HTML, but before you use any Firebase services -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script>
        async function verifyPlate() {
            const firebaseConfig = {
                apiKey: "AIzaSyAXk8gPSjviouGc-pfkoXdFzHDcy_fR-dM",
                authDomain: "adminproject-129f1.firebaseapp.com",
                databaseURL: "https://adminproject-129f1.firebaseio.com",
                projectId: "adminproject-129f1",
                storageBucket: "adminproject-129f1.appspot.com",
                messagingSenderId: "52547207023731",
                appId: "1:944478240098:android:794f67ffbebd2508bac03b",
            };
            const plateNum = document.getElementById("vehicleNo").value;
            const app = firebase.initializeApp(firebaseConfig);
            const db = app.firestore();
            var flag = false;
            var data = [];
            const users = await db.collection("users").get();
            users.forEach((doc) => {
                if (checkPlate(doc.data().plate) == true) {
                    flag = true;
                    data.push(doc.data());
                }
            });
            console.log(data);
            console.log(data[0].latest_entry_id);
            if (flag == true && data[0].latest_entry_id != undefined) {
                // get the details from parking-entries collection
                const docRef = await db.collection("parking-entries").doc(data[0].latest_entry_id);
                docRef.get().then((doc) => {
                    if (doc.exists) {
                        console.log(doc.data());
                        sessionStorage.setItem("loc", doc.data().location);
                        sessionStorage.setItem("time", doc.data().timestamp.toDate().toString());
                        sessionStorage.setItem("plateNo", plateNum);
                        sessionStorage.setItem("phone", data[0].phone);
                        sessionStorage.setItem("name", data[0].name);
                        sessionStorage.setItem("colour", data[0].colour);
                        sessionStorage.setItem("brand", data[0].brandModel);
                        //console.log(sessionStorage);
                        window.location.href = "checkFound.html";
                    }
                    else {
                        console.log("document lost.");
                    }
                })                
            }
            else {
                window.location.href = "checkNotFound.html";
            }
        }

    </script>
</body>

</html>